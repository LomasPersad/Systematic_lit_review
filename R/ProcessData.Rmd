---
title: "Process data"
author: "LPersad"
date: "2023-08-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(openxlsx)
# library(ggplot2)
library(plotly)
library(ggpubr)
# library(RColorBrewer)
library(rcartocolor)
```

## Resources
metagear
http://lajeunesse.myweb.usf.edu/metagear/metagear_basic_vignette.html


create flowdiagram online
https://estech.shinyapps.io/prisma_flowdiagram/

# Review of systematic review/ meta-analysis process

https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/preface.html




```{r paper data}


# Import the CSV file
studyID <- read.csv("./included/my_data_batch1/studyID_details_B1.csv")
data <- read.xlsx("./included/ALLdata_batch1.xlsx")
# Step 1: Clean Data Remove columns with no data
# data_cleaned <- data %>% select_if(~ any(!is.na(.)))
# colnames(studyID)

#reduce df
# Select specific columns and rename them
data_r <- data %>%
  select(CovidenceID = CovidenceID, aveAge = "aveAge.(years)",aveHeight = "aveHeight.(cm)",
         aveWeight="aveWeight.(kg)",N="Number.of.subjects,.N",Muscle=Muscle,Type=Type,
         Gender=Gender,CSA=CSA,Miscellaneous=Miscellaneous,aveVol="aveVol.(cm3)",
         aveFL="aveFL.(cm)",avePCSA="avePCSA.(cm2)",aveTorque="aveTorque.(Nm)",
         aveForce="aveForce.(N)",aveST="aveST.(N/cm2)")



# Combine the necessary columns in 'studyID' to create the mapping
studyID_mapping <- studyID %>%
  mutate(combined_text = paste('#', Covidence.., ' ', Study.ID, '-', Title))


# Merge 'data' with 'studyID_mapping' based on 'CovidenceID'
data_r <- data_r %>%
  left_join(studyID_mapping, by = c('CovidenceID' = 'Covidence..'))

# Rename the new column to 'Title'
names(data) <- sub('combined_text', 'plt_Title', names(data))

# colnames(data_r)

# Extract the age range value
data_r$age_range <- gsub(".*?(YNG|OLD|MID).*", "\\1", data_r$Type)


# dataframeName$colName <- as.factor(datataframeName$colName)

#-----------------------------DATA cleaning/reduction

# Grouped plot..

grp_data <- data_r %>%
  group_by(CovidenceID, Muscle) %>%
  summarise(avg_ST= mean(aveST, na.rm = FALSE), Ave_N=mean(as.numeric(N), na.rm = FALSE))


# Create the plot
ggplot(grp_data, aes(x = Muscle, y = avg_ST, size = Ave_N)) +
  geom_point(size = 4) +
  labs(title = "Muscle vs Specific Tension (N/cm2)", x = "Muscle", y = "Specific Tension (N/cm2)", color = "Age Range") +
  # scale_shape_manual(values = c("F" = 3, "M" = 16)) + # Define shapes for Gender
  # scale_color_manual(values = c("UT" = "blue", "T" = "red")) + # Define colors for Type
  # scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(legend.position = "right") 


```
## Plots
```{r}


# Assuming your data frame is named 'df'
# Replace 'df' with the actual name of your data frame

# Create the plot
ggplot(data_r, aes(x = Muscle, y = aveST, color = age_range, shape = Gender)) +
  geom_point(size = 4) +
  labs(title = "Muscle vs Specific Tension (N/cm2)", x = "Muscle", y = "Specific Tension (N/cm2)", color = "Age Range") +
  scale_shape_manual(values = c("F" = 3, "M" = 16)) + # Define shapes for Gender
  # scale_color_manual(values = c("UT" = "blue", "T" = "red")) + # Define colors for Type
  # scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  theme(legend.position = "right") 
  # guides(color = guide_colorbar(title = "Count"))

#--------------get color pallete
#option1
# n <- 14
# qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
# col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
# # pie(rep(1,n), col=sample(col_vector, n))

#Option2
nColor <- 14
scales::show_col(carto_pal(nColor, "Safe"))
manualcolors<-c('black','forestgreen', 'red2', 'orange', 'cornflowerblue', 
                'magenta', 'darkolivegreen4', 'indianred1', 'tan4', 'darkblue', 
                'mediumorchid1','firebrick4',  'yellowgreen', 'lightsalmon', 'tan3',
                "tan1",'darkgray', 'wheat4', '#DDAD4B', 'chartreuse', 
                'seagreen1', 'moccasin', 'mediumvioletred', 'seagreen','cadetblue1',
                "darkolivegreen1" ,"tan2" ,   "tomato3" , "#7CE3D8","gainsboro")

col_vector <- c(carto_pal(nColor, "Safe"), 'magenta', 'indianred1')

#combine studyID and muscle
 data_r$pltT <- paste(data_r$Study.ID, ',',data_r$Muscle)
 data_r <- data_r %>% drop_na(aveST)
 
ggdotchart(data_r, x="pltT", y="aveST",
           color="Muscle",
           palette = col_vector,
           sorting = "descending",
           add = "segments",
           rotate=TRUE,
           group="Study.ID",
           dot.size=12,
           label=round(data_r$aveST),
           font.label = list(color="white", size=9, vjust=0.5),
           ggtheme = theme_pubr(),
           legend.title = "Muscle(s)",
           ylab=FALSE,
           xlab = "Horsepower")

+data_r

```

##Testing
```{r paper data}
# Create the scatter plot
plot <- plot_ly(data_r, x = ~Muscle, y = ~aveST, type = "scatter", mode = "markers",
                marker = list(size = 10, opacity = 0.8))

# Customize the layout
layout <- list(
  title = "Muscle vs aveST",
  xaxis = list(title = "Muscle"),
  yaxis = list(title = "aveST")
)

# Combine the plot and layout
scatter_plot <- plot %>% layout(layout)

# Display the plot
scatter_plot






```
## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# Create the grouped bar chart
bar_chart <- plot_ly(data_r, x = ~Muscle, y = ~aveST, color = ~age_range, type = "bar")

# Customize the layout
layout <- list(
  title = "Muscle vs aveST (Grouped by Type)",
  xaxis = list(title = "Muscle"),
  yaxis = list(title = "aveST")
)

# Combine the plot and layout
bar_chart <- bar_chart %>% layout(layout)

# Display the plot
bar_chart



# Create the box plot
box_plot <- plot_ly(data_r, x = ~Muscle, y = ~aveST, color = ~age_range, type = "box")

# Customize the layout
layout <- list(
  title = "Box Plot of aveST (Grouped by Muscle and Type)",
  xaxis = list(title = "Muscle"),
  yaxis = list(title = "aveST")
)

# Combine the plot and layout
box_plot <- box_plot %>% layout(layout)

# Display the box plot
box_plot





# Create the box plot
box_plot <- plot_ly(data_r, x = ~Muscle, y = ~aveST, color = ~age_range, type = "box") %>%
  add_trace(x = ~Muscle, split = ~age_range)
# Customize the layout
layout <- list(
  title = "Box Plot of aveST (Grouped by Muscle, Type, and Age)",
  xaxis = list(title = "Muscle"),
  yaxis = list(title = "aveST"),
  boxmode = "group"
)

# Combine the plot and layout
box_plot <- box_plot %>% layout(layout)

# Display the box plot
box_plot
```

#ggpubr plots

```{r}
box_plot <- ggboxplot(data_r, x = "Muscle", y = "aveST",
                      color = "age_range",
                      add = "jitter", 
                      ylab = "Specific Tension (N/cm2)")


box_plot + labs(title = "Box Plot of aveST",
                x = "Muscle",
                color = "age_range",
                fill = "Gender")
# Define the custom legend labels and their order

custom_legend_labels <- c("CHD", "YNG", "MID", "OLD")
custom_labels <- c("CHD" = "<18yrs", "YNG" = "18-35yrs", "MID" = "35-65yrs", "OLD" = ">65yrs")

# Change the legend labels and order
box_plot + scale_fill_manual(values = c("CHD" = "orange", "MID" = "green","OLD" = "blue", "YNG" = "purple"),
                             breaks = custom_legend_labels,
                             labels = custom_labels)

```

